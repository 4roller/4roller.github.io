<html>

<head>
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>


<body>
    <h1>üèÅ <span class="brandStyle"><span class="italic">Tuner</span> Shop</span> üöóüí® </h1>
    <h2 class="name">Subaru Impreza</h2>
    <div class="spec">
        <div class="p2w">0</div>
        <div class="eff">0</div>
        <div class="hp">0</div>
        <div class="whp">0</div>
        <div class="weight">0</div>
        <div class="cost">0</div>
    </div>
    <div class='v1'>
    </div>

    <div class="tunerShop">
        <h2>üîß Tuner Parts</h2>
        <div class="mods"></div>
    </div>

</body>

</html>

<script src="cars.js"></script>

<script>

    let tabindex = 0;
    let currentVehicle = 'SUBARU_IMPREZA_2016_NACVT';
    const GAINS_DEFAULT = {
        eff: 0,
        hp: 0,
        whp: 0,
        weight: 0,
        cost: 0,
    };

    const getPowerToWeight = function (obj) {
        let outputPower = (obj.whp / obj.weight * 10000).toFixed();
        return outputPower;
    }

    const calculateMods = function (c) {
        let uc = { ...c };
        let mods;
        let totalPower = 0;
        let totalWeight = 0;
        let totalHandling = 0;
        let totalEfficiency = 0;

        if (c.mods) {
            mods = c.mods;

            mods.forEach((m) => {
                if (m.enabled) {
                    if (m.power) {
                        totalPower = totalPower + m.power;
                    }
                    if (m.weight) {
                        totalWeight = totalWeight + m.weight;
                    }
                    if (m.handling) {
                        totalHandling = totalHandling + m.handling;
                    }
                    if (m.drivetrain) {
                        totalEfficiency = totalEfficiency + m.drivetrain;
                    }
                }
            })
        }

        uc.effGain = totalEfficiency / 100;
        uc.hp = (uc.hp + totalPower).toFixed(0);
        let loss = uc.hp * ((DRIVETRAIN[uc.drive].driveloss / 100) - uc.effGain);
        uc.powerGain = totalPower.toFixed(0);
        uc.weight = uc.weight - totalWeight;
        uc.whp = (uc.hp - loss).toFixed(0);
        return uc;
    }

    const getVsCode = (car) => {
        const returnCarRow = document.createElement('div');
        let c = car;
        let p2w = getPowerToWeight(c);

        const tierClass = 'tier-' + getTier(c);
        returnCarRow.classList.add(tierClass);
        returnCarRow.classList.add('vehicle');
        returnCarRow.setAttribute('data-id', c.image);
        returnCarRow.setAttribute('tabindex', tabindex++);

        let engineSpecial = '';
        if (c.oem == 'Subaru') {
            engineSpecial = "Boxer ü•ä"
        }

        let carRow = `        
            <div class="exp">${p2w}</div>
            <div class="image-wrap">
                <img src="images/${c.image}.png" />
            </div>
            <div class="vehicle-name">
                <div class="mmy">${c.oem} ${c.model}</div>
                <div class="mmy mmy-sub">${c.trim} ${c.year}</div>
            </div>
            
            <div class="vehicle-data unit-sq">
                <div class="ed">${c.drive} ${c.engineType} ${c.trans} </div>
                <div class="et">${c.displacement}L ${c.cylOr}${c.cylNum} ${engineSpecial} </div>
                <div class="hp">${c.hp}hp/${c.weight}lbs</div>
                <div class="gains">
                    <span class="effGain">${(c.effGain * 100).toFixed(0)}%</span>
                    <span class="hpGain">${c.powerGain}hp</span>
                    <span class="whp">${c.whp}whp</span>
                </div>
            </div>            
        `
        returnCarRow.innerHTML = carRow;
        return returnCarRow;
    }


    const getTier = function (c) {
        const p2w = getPowerToWeight(c);
        c.tier = 0;
        // Tier 1 cars
        if (p2w < 300) {
            c.tier = 1;
        }
        if (p2w > 435) {
            c.tier = 2;
        }
        if (p2w > 500) {
            c.tier = 3;
        }
        if (p2w > 600) {
            c.tier = 4;
        }
        if (p2w > 700) {
            c.tier = 5;
        }
        if (p2w > 950) {
            c.tier = 6;
        }

        return c.tier;
    }

    const updateMods = function () {        
        modsContainer.innerHTML = '';

        const mods = CARS[currentVehicle].mods;
        if (!mods) {
            modsContainer.innerHTML = 'No mods available at this time';
            return;
        }
        const ul = document.createElement('ul');

        mods.forEach(el => {
            let modEl = document.createElement('li');
            modEl.classList.add('mod');
            let power = '';
            let weight = '';
            let handling = '';
            let drivetrain = '';

            if (el.power) {
                power = `+${el.power}HP`;
            }
            if (el.drivetrain) {
                drivetrain = `+${el.drivetrain}% EFF`;
            }
            if (el.handling) {
                handling = `+${el.handling} AGI`;
            }
            if (el.weight) {
                weight = `${0 - el.weight}lb`;
            }

            modEl.innerHTML = `                
                <input type="checkbox" id="" name="${el.type}" value="${el.type}" >
                <div class=type>${el.type}</div>
                <div>${el.manufacturer}</div>
                <div class="description">${el.description}</div>
                <div class="gains">${power} ${weight} ${handling} ${drivetrain}</div>
                <div class="cost">${el.cost}</div>
            `;
            ul.appendChild(modEl);
        })
        mods.innerHTML = '';
        modsContainer.appendChild(ul);
    }

    const getParent = function (el, classToFind) {
        if (el.classList.contains(classToFind)) {
            return el;
        }
        else {
            return getParent(el.parentElement, classToFind);
        }
    }

    const updateSpec = function (gains, vehicle) {
        if (typeof vehicle === 'string' || !vehicle) {
            vehicle = CARS[vehicle];
        }

        let inVehicle = vehicle;
        if (!vehicle) {
            vehicle = CARS['SUBARU_IMPREZA_2016_NACVT'];
        }

        const v = vehicle;
        document.querySelector('h2.name').innerHTML = `${v.oem} ${v.model} ${(v.engineName) ? v.engineName : ''}`;
        const driveLossPercentage = (DRIVETRAIN[v.drive].driveloss / 100);
        let effGain = gains.eff / 100;
        let hpGain = v.hp + gains.hp;
        let loss = hpGain * (driveLossPercentage - effGain);
        const stockWhp = (v.hp - (v.hp * driveLossPercentage)).toFixed(0);
        const stockLoss = v.hp * (DRIVETRAIN[v.drive].driveloss / 100);
        let whp = ((hpGain - loss)).toFixed(0);

        let cost = `${gains.cost}`;
        let weight = `${v.weight - gains.weight} lb <br />(${0 - gains.weight} lb)`;
        let hp = `${v.hp} +${gains.hp} HP<br /><span class="elite">${v.hp + gains.hp} BHP</span>`;
        let whpOutput = `${stockWhp}  +${whp - stockWhp} HP<br/> <span class="elite">${whp} WHP</span>`;
        let eff = `${gains.eff - DRIVETRAIN[v.drive].driveloss}%  ${v.drive}<br /><span class="elite">+${gains.eff}% gain</span>`;
        const obj = {
            'whp': whp,
            'weight': (v.weight - gains.weight),
        }
        let p2w = `<span class="eliteRobin">${getPowerToWeight(obj)}</span><br />PowerIndex`;

        specContaier.querySelector('.cost').innerHTML = cost;
        specContaier.querySelector('.eff').innerHTML = eff;
        specContaier.querySelector('.weight').innerHTML = weight;
        specContaier.querySelector('.hp').innerHTML = hp;
        specContaier.querySelector('.whp').innerHTML = whpOutput;
        specContaier.querySelector('.p2w').innerHTML = p2w;
        return;
    }

    const handleModsClick = function (e) {
        e.preventDefault();
        let thing = getParent(e.target, 'mod');
        let input = thing.querySelector('input');
        input.checked = !input.checked;
        thing.classList.toggle('selected')
        selectedMod = thing.querySelector('.type').innerHTML;
        let gains = { ...GAINS_DEFAULT };


        CARS[currentVehicle].mods.forEach(el => {
            if (el.type === selectedMod) {
                if (input.checked) {
                    el.enabled = true;
                } else {
                    el.enabled = false;
                }
            }
            if (el.enabled) {
                if (el.cost) {
                    gains.cost += el.cost;
                }
                if (el.drivetrain) {
                    gains.eff += el.drivetrain;
                }
                if (el.power) {
                    gains.hp += el.power;
                }
                if (el.weight) {
                    gains.weight += el.weight;
                }
            }
        });
        updateSpec(gains);
        paint();
    }


    const paint = function () {
        tabindex = 0;
        v1Contaier.innerHTML = '';
        carArr = [];

        for (c in CARS) {
            let uc = calculateMods(CARS[c]);
            //let uc = { ...CARS[c] };
            carArr.push(uc);
        }

        let cars = carArr.sort(function (a, b) {
            return getPowerToWeight(a) - getPowerToWeight(b);
        });

        cars.forEach(function (c) {
            v1Contaier.appendChild(getVsCode(c));
        });




    }

    const handleCarSelector = function (e) {
        let thing = getParent(e.target, 'vehicle').getAttribute('data-id');
        for (c in CARS) {
            if (CARS[c].image == thing) {
                currentVehicle = c;
                updateSpec(GAINS_DEFAULT, CARS[c]);
                updateMods();
                break;
            };
        }
        return;
    };


    const v1Contaier = document.querySelector('.v1');
    const specContaier = document.querySelector('.spec');
    const modsContainer = document.querySelector('.mods');
    let carArr = [];

    // VS AUTO!


    modsContainer.addEventListener('click', handleModsClick);
    v1Contaier.addEventListener('click', handleCarSelector);

    paint();
    updateSpec(GAINS_DEFAULT, currentVehicle);
    updateMods();










</script>